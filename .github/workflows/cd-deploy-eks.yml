name: CD - Deploy to EKS

on:
  workflow_run:
    workflows: ["CI - Build and Push to ECR"]
    types: [completed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'prod'
        type: choice
        options: [dev, prod]

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: cloudshelf-eks

jobs:
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}

      - name: Verify cluster access
        run: |
          kubectl get nodes
          kubectl cluster-info

      - name: Deploy namespace
        run: kubectl apply -f spring-microservices-bookstore-demo/kubernetes/00-namespace/

      - name: Update image registry in deployments
        run: |
          cd spring-microservices-bookstore-demo/kubernetes
          find 04-services -name "deployment.yaml" -type f -exec sed -i 's|image: shpro123/|image: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/cloudshelf/|g' {} +

      - name: Deploy static secrets (MongoDB, Kafka, API-Gateway)
        run: kubectl apply -f spring-microservices-bookstore-demo/kubernetes/02-secrets/
      
      - name: Dynamic RDS Secret for reviews-service
        run: |
          RDS_ENDPOINT=$(aws rds describe-db-instances \
            --db-instance-identifier cloudshelf-db \
            --region ${{ env.AWS_REGION }} \
            --query 'DBInstances[0].Endpoint.Address' \
            --output text)

          if [[ "$RDS_ENDPOINT" == "None" || -z "$RDS_ENDPOINT" ]]; then
            echo "‚ùå RDS endpoint not found ‚Äî skipping reviews-db-credentials"
          else
            echo "üîß Creating reviews-db-credentials with host: $RDS_ENDPOINT"
            kubectl delete secret reviews-db-credentials -n cloudshelf --ignore-not-found
            kubectl create secret generic reviews-db-credentials \
              --namespace cloudshelf \
              --from-literal=SPRING_DATASOURCE_URL="jdbc:postgresql://${RDS_ENDPOINT}:5432/reviews_db" \
              --from-literal=SPRING_DATASOURCE_USERNAME="reviews_user" \
              --from-literal=SPRING_DATASOURCE_PASSWORD="ReviewsSecure123!" \
              --dry-run=client -o yaml | kubectl apply -f -
          fi

      - name: Deploy ConfigMaps
        run: kubectl apply -f spring-microservices-bookstore-demo/kubernetes/01-configmaps/

      - name: Deploy infrastructure (MongoDB, Kafka, Zipkin)
        run: kubectl apply -f spring-microservices-bookstore-demo/kubernetes/03-infrastructure/

      - name: Wait for core infrastructure
        run: |
          kubectl wait --for=condition=ready pod -l app=mongodb -n cloudshelf --timeout=300s
          kubectl wait --for=condition=ready pod -l app=kafka -n cloudshelf --timeout=300s

      - name: Deploy all microservices
        run: |
          for service in api-gateway book-service author-service order-service stock-check-service message-service reviews-service frontend; do
            kubectl apply -f spring-microservices-bookstore-demo/kubernetes/04-services/$service/deployment.yaml
          done

          kubectl wait --for=condition=available --timeout=600s \
            deployment/api-gateway \
            deployment/book-service \
            deployment/author-service \
            deployment/order-service \
            deployment/stock-check-service \
            deployment/message-service \
            deployment/reviews-service \
            deployment/frontend -n cloudshelf

      - name: Deploy Ingress
        run: kubectl apply -f spring-microservices-bookstore-demo/kubernetes/05-ingress/

      - name: Update Frontend + Gateway ConfigMaps with ALB Hostname
        run: |
          echo "‚è≥ Waiting for ALB..."
          for i in {1..30}; do
            HOST=$(kubectl get ingress cloudshelf-ingress -n cloudshelf -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
            if [[ -n "$HOST" ]]; then break; fi
            sleep 15
          done
          if [[ -z "$HOST" ]]; then
            echo "‚ö†Ô∏è ALB not ready ‚Äî skipping CM patch"
            exit 1
          fi
          kubectl patch configmap frontend-config -n cloudshelf --type merge -p \
            "{\"data\":{\"NEXT_PUBLIC_API_BASE\":\"http://$HOST/api\"}}"
          kubectl patch configmap api-gateway-config -n cloudshelf --type merge -p \
            "{\"data\":{\"CORS_ALLOWED_ORIGINS\":\"http://$HOST\"}}"
          kubectl rollout restart deployment/frontend -n cloudshelf
          kubectl rollout restart deployment/api-gateway -n cloudshelf

      - name: Show Deployment Summary
        run: |
          echo "=== Cloudshelf Deployment Complete ==="
          kubectl get pods -n cloudshelf
          kubectl get ingress -n cloudshelf
